#!/bin/bash

##################################################
# Imports
##################################################

. ScriptFunctions
Import OptionParser
Import File
Import Terminal
Import GoboLinux
Import Array

##################################################
# Options and configuration
##################################################

Parse_Conf Compile.conf
Import Compile

helpOnNoArguments=yes
scriptDescription="Given a recipe, download the files required to compile it."
scriptUsage="<recipe> [arch-recipe]"
scriptExample="$compileRecipeDir/K3B/0.10/Recipe"
Add_Option_Entry   "d" "save-directory" "Rename the directory into which the archive is unpacked/files checked out." ""
Add_Option_Entry   "s" "save-to" "Save the files to the given directory" "$compileArchivesDir"
Add_Option_Boolean "b" "batch" "Avoid asking questions."
Parse_Options "$@"

savedir=$(Entry "save-to")
sourcedir=$(Entry "save-directory")

if Is_Writable "$savedir" || [ "$compileDisableSudo" = "yes" ]
then sudo=
else sudo="sudo -u #0"
fi

if wget --help | grep -q no-check-certificate
then wget="wget --no-check-certificate"
else wget="wget"
fi

##################################################
# Fundamental variables
##################################################

scriptsversion=`Get_Version Scripts Current`
svnr=`echo $scriptsversion | sed 's/\([0-9]*\).*/\1/g'`
smajormiddle=`echo $scriptsversion | sed 's/^\([0-9]*\.[0-9]*\).*$/\1/g'`
is_cvs=`echo $scriptsversion | grep -i CVS`
if [ ! "$is_cvs" ] && [ "$svnr" -gt 5 ] || \
   [ `GuessLatest $smajormiddle 2.1` != $smajormiddle -a ! "$is_cvs" ]
then
   Die "Your Scripts package is too old. Please update it by running 'InstallPackage Scripts'."
fi

recipe="$(Arg 1)"
[ "$recipe" ] || Die "Missing argument. Usage: $scriptName <recipe>. See --help."
[ -e "$recipe" ] || Die "File not found: $recipe"
. "$recipe"

archrecipe="$(Arg 2)"
[ -e "$archrecipe" ] && source "$archrecipe"

[ -z "${sourcedir}" ] && sourcedir="${dir%%/*}"
##################################################
# Get sources
##################################################

if [ "$cvs" ]
then
   cd "$savedir"
   [ -z "${sourcedir}" ] && sourcedir="$(echo ${recipe} | sed 's,.*/\([^/]*\)/\([^/]*\)/Recipe,\1-\2,')"
   [ "$cvs_password" = "" ] && extra_info="( Just press enter )"
   echo "CVS PASSWORD is \"$cvs_password\"${extra_info}"

   login_method=`echo ${cvs} | cut -b-5`
   [ "$cvs_rsh" ] && export CVS_RSH=$cvs_rsh || export CVS_RSH=ssh
   [ "$login_method" != ":ext:" ] && cvs -d${cvs} login
   cvs -d${cvs} ${cvs_opts} ${cvs_options} checkout -d"$sourcedir" ${cvs_checkout_options} ${cvs_module}
   exit $?
elif [ "$svn" ]
then
   cd "$savedir"
   [ -z "${sourcedir}" ] && sourcedir="$(echo ${recipe} | sed 's,.*/\([^/]*\)/\([^/]*\)/Recipe,\1-\2,')"
   if [ "$svn_username" ] 
   then svn checkout $svn "${sourcedir}" --username "$svn_username" --password "$svn_password"
   else svn checkout $svn "${sourcedir}"
   fi
   exit $?
elif ! [ -n "$url${urls[*]}" ]
then
   Die "Missing URL in recipe '$recipe'."
fi

for var in url mirror_url file file_size file_md5
do
   eval '
      if [ -n "$'$var'" -a ! -n "${'$var's[*]}" ]
      then '$var's=("$'$var'")
      fi
   '
done

if ! [ "${files[*]}" ]
then files=(`Map basename "${urls[@]}"`)
fi

Quiet pushd "$savedir"
for i in `seq 0 $[${#urls[@]}-1]`
do
   file="${files[i]}"
   Verify_Files "$file" "${file_sizes[i]}" "${file_md5s[i]}"
   result=$?
   if [ "$result" = "0" ]
   then
      continue
   elif [ "$result" = "1" ]
   then
      rm -f -- ${file}
   elif [ "$result" = "2" ]
   then
      if Boolean "batch" || Ask "Remove and download again?"
      then rm -f ${file}
      else continue
      fi
   fi

   function wget_url() {
      fileindex=$1
      mirrorlevel=$2
      urlcount="${#urls[@]}"
      if [ "$mirrorlevel" = 0 ]
      then fetch="${urls[fileindex]}"
      else fetch="${mirror_urls[(mirrorlevel-1)*urlcount+fileindex]}"
      fi
      if [ -z "$fetch" ]
      then
         # Fail! No more mirrors!
         return 1
      fi
      local file="${files[fileindex]}"
      unset LANG LC_ALL # So that wget's output is not translated
      if [ -e "$file" ]
      then
         if Starts_With "http:" "$fetch"
         then
            expectedlength=`$sudo $wget --spider "$fetch" 2>&1 | grep "Length:" | tr -d ".," | cut -d" " -f2`
            locallength=`wc -c "$file" | cut -d" " -f1`
            if [ "$expectedlength" = "$locallength" ]
            then
               Log_Verbose "$file is already fully retrieved."
               return 0
            fi
         fi
      fi
      $sudo $wget -O "$file" -c --passive-ftp "$fetch" || {
         wget_url "$fileindex" "$[mirrorlevel+1]"
      }
   }

   wget_url "$i" 0 || {
      Die "Could not fetch '$url'."
   }
done
Quiet popd
