#!/bin/bash

##################################################
# Imports
##################################################

. ScriptFunctions
Import OptionParser
Import File
Import GoboLinux

##################################################
# Options and configuration
##################################################

Parse_Conf Compile.conf

scriptDescription='Generate "packed recipes", ready for submission.'
scriptCredits="(C) 2003-2004 Carlo Calica et al. Released under the GNU GPL."
scriptUsage="[<program> [<version>]]"
scriptNotes="Given no arguments, this script will take all recipes in $compileLocalRecipesDir and "\
"pack them as Foo--1.0--recipe.tar.bz2 files at $compilePackedRecipesDir."
Add_Option_Boolean "L" "no-lint" "Do not verify recipes (not recommended)."
Add_Option_Boolean "W" "no-web" "Offline operation when running RecipeLint (avoid if possible)."
Parse_Options "$@"

if Boolean "no-web"
then noweb=--no-web
else noweb=
fi

Verify_Superuser "$compilePackedRecipesDir"

##################################################
# Helper functions
##################################################

Import Compile

##################################################
# Prepare Environment
##################################################

Check_Dir_Variable compilePackedRecipesDir
Check_Dir_Variable compileLocalRecipesDir

##################################################
# Operation
##################################################

handle_description() {
   local name="$1"
   local version="$2"

   # Handle descriptions
   description="$name/$version/Resources/Description"
   if ! [ -e "$description" ]
   then
      mkdir -p $name/$version/Resources/
      DescribeProgram $name > "$description"
      if [ `cat $description | wc -c` -eq 0 ]
      then
         rm $description
         license=""
         sourcedir="$compileSourcesDir/$(echo $name | tr '[:upper:]' '[:lower:]')-$version"
         if [ ! -d "$sourcedir" ]
         then
            sourcedir="$compileSourcesDir/$name-$version"
         fi
         if [ -d "$sourcedir" ]
         then
            for licensefile in $sourcedir/COPYING* $sourcedir/LICENSE* $sourcedir/license*
            do
               if [ -e $licensefile ]
               then
                  md5license=`md5sum $licensefile | cut -d" " -f1`
                  case "$md5license" in
                  # GPL2 Mass Ave
                  8ca43cbc842c2336e835926c2166c28b) newlicense="GNU General Public License version 2" ;;
                  18810669f13b87348459e611d31ab760) newlicense="GNU General Public License version 2" ;;
                  7975d4f2e1ca1e9df4dcfd94c6e1ae48) newlicense="GNU General Public License version 2" ;;
                  # GPL2 Franklin St mentions Library
                  59530bdf33659b29e73d4adb9f9f6552) newlicense="GNU General Public License version 2" ;;
                  751419260aa954499f7abaabaa882bbe) newlicense="GNU General Public License version 2" ;;
                  # GPL2 Temple Place
                  94d55d512a9ba36caa9b7df079bae19f) newlicense="GNU General Public License version 2" ;;
                  393a5ca445f6965873eca0259a17f833) newlicense="GNU General Public License version 2" ;;
                  fdafc691aa5fb7f8e2a9e9521fef771b) newlicense="GNU General Public License version 2" ;;
                  # GPL2 Linux kernel
                  d7810fab7487fb0aad327b76f1be7cd7) newlicense="GNU General Public License version 2" ;;
                  # LGPL2 Mass Ave
                  55ca817ccb7d5b5b66355690e9abc605) newlicense="GNU Library General Public License version 2" ;;
                  ac4e4df3bbeacd481df543d2b12860b3) newlicense="GNU Library General Public License version 2" ;;
                  # LGPL2 Temple Place
                  3bf50002aefd002f49e7bb854063f7e7) newlicense="GNU Library General Public License version 2" ;;
                  7be2873b6270e45abacc503abbe2aa3d) newlicense="GNU Library General Public License version 2" ;;
                  f30a9716ef3762e3467a2f62bf790f0a) newlicense="GNU Library General Public License version 2" ;;
                  c46bda00ffbb0ba1dac22f8d087f54d9) newlicense="GNU Library General Public License version 2" ;;
                  # LGPL2.1
                  fad9b3332be894bab9bc501572864b29) newlicense="GNU Lesser General Public License version 2.1" ;;
                  d7b37bf80a3df5a65b355433ae36d206) newlicense="GNU Lesser General Public License version 2.1" ;;
                  fbc093901857fcd118f065f900982c24) newlicense="GNU Lesser General Public License version 2.1" ;;
                  # MPL1.1
                  bfe1f75d606912a4111c90743d6c7325) newlicense="Mozilla Public License 1.1" ;;
                  *)
                     Log_Terse "Could not autodetermine licensing for writing the Description file."
                     Ask_Continue "Press Enter to view the license file $licensefile."
                     ${PAGER:-less} $licensefile
                     ;;
                  esac # esac is ridiculous.
                  if [ "$license" = "" ]
                  then license="$newlicense"
                  else license="$license, $newlicense"
                  fi
               fi
            done
         fi
         if [ "$license" = "" ]
         then license="***REPLACE THIS WITH THE NAME OF THE LICENSE***"
         fi
cat <<EOF > $description
[Name] $name
[Summary] ***REPLACE THIS WITH A SHORT ONE LINE DESCRIPTION***
[Description] ***REPLACE THIS WITH A MORE DETAILED DESCRIPTION***
[License] $license
[Homepage] ***REPLACE THIS WITH THE HOMEPAGE URL***
EOF
         $EDITOR $description
         while grep -q "***REPLACE" $description
         do
            if Ask "Description wasn't filled properly. Retry?"
            then $EDITOR $description
            else
               rm $description
               return 1
            fi
         done
      fi
   fi
   return 0
}

pack_recipe() {
   local name="$1"
   local version="$2"
   archive="$name--$version--recipe.tar.bz2"
   Log_Verbose "Package: $archive"
   cd "$compileLocalRecipesDir"
   tarball="$compilePackedRecipesDir/$name--$version--recipe.tar.bz2"

   handle_description "$name" "$version"

   create_tarball() {
      recipe="$name/$version/Recipe"
      resources="$name/$version/Resources"
      description="$resources/Description"
      Exists "$recipe" || return 1
      if ! Exists "$description"
      then
         Quiet mkdir "$resources"
         DescribeProgram --mode=ascii "$name" > "$description" || {
            rm "$description"
            Quiet rmdir "$resources"
         }
      fi
      #remove backups
      find "$name/$version" | grep -E '~$' | xargs rm -f
      Verbose tar cjvf "$tarball" --exclude=.svn "$name/$version" || return 1
      touch "$tarball" --reference="$name/$version/Recipe"
      return 0
   }

   if create_tarball
   then
      if ! Boolean "no-lint"
      then 
         RecipeLint $noweb "$tarball"
         recipestatus=$?
         if [ "$recipestatus" -eq 1 ]
         then
            Log_Error "RecipeLint reported warnings in $name $version."
            if ! Ask "Proceed and pack it anyway?"
            then return
            fi
         elif [ "$recipestatus" -eq 2 ]
         then
            Log_Error "RecipeLint reported errors in $name $version from trunk. Not packing it."
            rm "$tarball"
            return
         fi
      fi
      Log_Normal "Packed $tarball."
   else
      Log_Error "Failed packing $tarball."
   fi
}

pack_all_versions() {
   for version in "$compileLocalRecipesDir/$1/"*
   do
      [ -L "$version" ] && continue
      pack_recipe "$1" `basename "$version"`
   done
}

if [ "$(Arg 1)" ]
then
   name=`ls "$compileLocalRecipesDir" | grep -i "^$(Arg 1)$"`
   if [ ! "$name" ]
   then Die "Could not find recipe directory for $(Arg 1) in $compileLocalRecipesDir."
   fi
   if [ "$(Arg 2)" ]
   then pack_recipe "$name" "$(Arg 2)"
   else pack_all_versions "$name"
   fi
else
   export lsfile="$compilePackedRecipesDir/RecipeList"
   for name in "$compileLocalRecipesDir/"*
   do
       name=`basename "$name"`
       pack_all_versions "$name"
   done
   cd "$compilePackedRecipesDir"
   ls *--recipe.tar.bz2 >"$lsfile"
fi

