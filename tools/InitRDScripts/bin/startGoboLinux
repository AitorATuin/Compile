#!/bin/ash

/bin/mount -t proc  none /System/Kernel/Status
/bin/mount -t sysfs none /System/Kernel/Objects
/bin/mount -t tmpfs none /System/Kernel/Devices

echo "Generating /System/Kernel/Devices"
/bin/miniudev >/dev/null

echo "Mounting GoboLinux Install CD..."
/bin/mountGoboLinux 

echo "Preparing TmpFS RW Layer..."
mount -t tmpfs none /Mount/TmpFS
mkdir /Mount/TmpFS/Programs

echo "Initializing GoboLinux squashfs files..."
# Mounting 'GoboLinux-{rest,files}.squashfs' (still harcoded names)
mount -o loop,ro -t squashfs /Mount/CD-ROM/GoboLinux-rest.squashfs  /Mount/SquashFS/Rest
mount -o loop,ro -t squashfs /Mount/CD-ROM/GoboLinux-files.squashfs /Mount/SquashFS/Files
# mount -t unionfs -o dirs=/Mount/TmpFS=rw:/Mount/SquashFS/Rest=ro:/Mount/SquashFS/Files=ro:/Mount/UnionFS=ro none /Mount/UnionFS

#
# Tricky block for /Depot, /Mount, /System and /Files
#
cd /Mount/SquashFS/Rest
for i in *
do
   [ -h $i ] && cp -a $i /Mount/TmpFS
done
cp -a Mount  /Mount/TmpFS
cp -a usr    /Mount/TmpFS
mkdir -p /Mount/TmpFS/Depot
mkdir -p /Mount/TmpFS/Files
mkdir -p /Mount/TmpFS/System
mount -t unionfs -o dirs=/Mount/TmpFS/System=rw:/Mount/SquashFS/Rest/System=ro none /Mount/TmpFS/System
mount -t unionfs -o dirs=/Mount/TmpFS/Files=rw:/Mount/SquashFS/Files/Files=ro none /Mount/TmpFS/Files

#
# Tricky block for /Programs
#
mkdir -p /Mount/TmpFS/Programs
mount -t unionfs -o dirs=/Mount/TmpFS/Programs=rw: none /Mount/TmpFS/Programs

# Mounting Packages*.squashfs files inside /Programs
# unionmountprograms="dirs=/Mount/TmpFS/Programs=rw"
for i in /Mount/CD-ROM/Packages*.squashfs; do
    mount -o loop,ro -t squashfs $i /Mount/SquashFS/`basename $i .squashfs`
    # unionmountprograms=$unionmountprograms:/Mount/SquashFS/`basename $i .squashfs`=ro
    unionctl /Mount/TmpFS/Programs --add --after /Mount/TmpFS/Programs \
             --mode ro /Mount/SquashFS/`basename $i .squashfs`
done
# mount -t unionfs -o $unionmountprograms none /Mount/UnionFS/Programs

# Remove unneeded mounts
/bin/umount /System/Kernel/Devices
/bin/umount /System/Kernel/Objects
# /bin/umount /System/Kernel/Status

echo "Performing pivot_root..."
cd /Mount/TmpFS
# cd /Mount/UnionFS
/bin/pivot_root . Mount/.Pivot

# ensure that the inittab from LiveCD is used. this is later replaced
# by the StartLiveCD script from the LiveCD package.
ln -nfs /Programs/LiveCD/Settings/inittab /System/Settings/inittab

echo "Invoking init..."
exec /sbin/init
echo "Done."
