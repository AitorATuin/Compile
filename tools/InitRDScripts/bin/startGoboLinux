#!/bin/ash

/bin/mount -t proc  none /System/Kernel/Status
/bin/mount -t sysfs none /System/Kernel/Objects
/bin/mount -t tmpfs none /System/Kernel/Devices
/bin/mount -t tmpfs none /Mount/UnionFS

echo "Generating /System/Kernel/Devices"
/bin/miniudev >/dev/null

echo "Mounting GoboLinux Install CD..."
/bin/mountGoboLinux 

echo "Preparing TmpFS RW Layer..."
mount -t tmpfs none /Mount/TmpFS
mkdir -p /Mount/TmpFS/Programs
mkdir -p /Mount/TmpFS/Depot 
mkdir -p /Mount/TmpFS/Files
mkdir -p /Mount/TmpFS/System

echo "Initializing GoboLinux squashfs files..."

# Mounting Packages*.squashfs files inside /Mount/SquashFS
unset unmanaged
unset unionmountprograms
for i in /Mount/CD-ROM/Packages*.squashfs
do
    squashdir=`basename $i .squashfs`
    mount -o loop,ro -t squashfs $i /Mount/SquashFS/$squashdir
    unionmountprograms="$unionmountprograms:/Mount/SquashFS/$squashdir=ro"
    
    for pkg in /Mount/SquashFS/$squashdir/Programs/*
    do
        udir="$pkg/Current/Resources/Unmanaged"
        [ -d "$udir" ] && unmanaged="$unmanaged $udir"
    done
done

# Mounting 'GoboLinux-{rest,files}.squashfs' (still harcoded names)
mount -o loop,ro -t squashfs /Mount/CD-ROM/GoboLinux-rest.squashfs  /Mount/SquashFS/Rest
mount -o loop,ro -t squashfs /Mount/CD-ROM/GoboLinux-files.squashfs /Mount/SquashFS/Files

dirs="/Mount/UnionFS=rw${unionmountprograms}:/Mount/SquashFS/Rest=ro:/Mount/SquashFS/Files=ro"
mount -t unionfs -o dirs=$dirs none /Mount/TmpFS
for dir in $unmanaged
do
   mount -t unionfs -o remount,add=:${dir}=ro none /Mount/TmpFS
done

# Remove unneeded mounts
/bin/umount /System/Kernel/Devices
/bin/umount /System/Kernel/Objects

echo "Performing pivot_root..."
cd /Mount/TmpFS
/bin/pivot_root . Mount/.Pivot

# ensure that the inittab from LiveCD is used. this is later replaced
# by the StartLiveCD script from the LiveCD package.
ln -nfs /Programs/LiveCD/Settings/inittab /System/Settings/inittab

echo "Invoking init..."
exec /sbin/init
echo "Done."
