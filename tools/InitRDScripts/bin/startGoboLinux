#!/bin/ash

/bin/mount -t proc  none /System/Kernel/Status
/bin/mount -t sysfs none /System/Kernel/Objects
/bin/mount -t tmpfs none /System/Kernel/Devices

echo "Generating /System/Kernel/Devices"
/bin/miniudev >/dev/null

echo "Mounting GoboLinux Install CD..."
/bin/mountGoboLinux 

echo "Preparing TmpFS RW Layer..."
mount -t tmpfs none /Mount/TmpFS
mkdir /Mount/TmpFS/Programs

echo "Initializing GoboLinux squashfs files..."

# Mounting Packages*.squashfs files inside /Programs
mkdir -p /Mount/TmpFS/Programs
unionmountprograms="dirs=/Mount/TmpFS/Programs=rw"
for i in /Mount/CD-ROM/Packages*.squashfs
do
    squashdir=`basename $i .squashfs`
    mount -o loop,ro -t squashfs $i /Mount/SquashFS/$squashdir
    unionmountprograms="$unionmountprograms:/Mount/SquashFS/$squashdir=ro"
done
mount -t unionfs -o $unionmountprograms none /Mount/TmpFS/Programs

# Union-mount Unmanaged files
unmanagedfiles="dirs=/Mount/TmpFS=rw"
cd /Mount/TmpFS/Programs
for i in *
do
    [ -d "$i/Resources/Unmanaged" ] || continue
    unmanagedfiles="$unmanagedfiles:/Mount/TmpFS/Programs/$i/Resources/Unmanaged=ro"
done
mount -t unionfs -o $unmanagedfiles none /Mount/TmpFS


# Mounting 'GoboLinux-{rest,files}.squashfs' (still harcoded names)
mount -o loop,ro -t squashfs /Mount/CD-ROM/GoboLinux-rest.squashfs  /Mount/SquashFS/Rest
mount -o loop,ro -t squashfs /Mount/CD-ROM/GoboLinux-files.squashfs /Mount/SquashFS/Files
cd /Mount/SquashFS/Rest
for i in *
do
   [ -h $i ] && cp -a $i /Mount/TmpFS
done
cp -a Mount /Mount/TmpFS
cp -a usr   /Mount/TmpFS
mkdir -p /Mount/TmpFS/Depot /Mount/TmpFS/Files /Mount/TmpFS/System
mount -t unionfs -o dirs=/Mount/TmpFS/System=rw:/Mount/SquashFS/Rest/System=ro none /Mount/TmpFS/System
mount -t unionfs -o dirs=/Mount/TmpFS/Files=rw:/Mount/SquashFS/Files/Files=ro none /Mount/TmpFS/Files

# Remove unneeded mounts
/bin/umount /System/Kernel/Devices
/bin/umount /System/Kernel/Objects

echo "Performing pivot_root..."
cd /Mount/TmpFS
/bin/pivot_root . Mount/.Pivot

# ensure that the inittab from LiveCD is used. this is later replaced
# by the StartLiveCD script from the LiveCD package.
ln -nfs /Programs/LiveCD/Settings/inittab /System/Settings/inittab

echo "Invoking init..."
exec /sbin/init
echo "Done."
