#!/bin/sh

cdrom=/Mount/CD-ROM

# Try IDE CDROMs
for d in /proc/ide/hd*
do
   type=`cat $d/media`
   if [ "$type" = "cdrom" ]
   then
      devname=`basename $d`
      device="/dev/$devname"
      mount -t iso9660 "$device" "$cdrom" 2> /dev/null
      # Check for squashfs
      ls $cdrom/*.squashfs 2> /dev/null && exit 0
      umount "$cdrom"
   fi
done

# Ok, try SCSI drives
for device in /dev/sr*
do
   mount -t iso9660 "$device" "$cdrom" 2> /dev/null
   # Check for squashfs
   ls $cdrom/*.squashfs 2> /dev/null && exit 0
   umount "$cdrom"
done

echo "Loading usb-storage..."
/bin/insmod /System/Kernel/Modules/usb-storage.ko

echo "Wait for USB bus to stabilize..."
sleep 15

echo "Regenerating /System/Kernel/Devices"
/bin/miniudev

# Ok, try SCSI drives (for USB)
for device in /dev/sr*
do
   mount -t iso9660 "$device" "$cdrom" 2> /dev/null
   # Check for squashfs
   ls $cdrom/*.squashfs 2> /dev/null && exit 0
   umount "$cdrom"
done

