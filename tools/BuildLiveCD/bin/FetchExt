#!/bin/sh

externalarchives=Archives/Ext
external=External

function get_md5() {
   md5sum "$1" 2>/dev/null | awk '{print $1}'
}

function check_and_dl() {
   dir="$1"
   url="$2"
   md5="$3"
   urlbn=`basename $url`
   localfile="$externalarchives/$urlbn"
   localmd5=`get_md5 "$localfile"`
   if ! [ "$localmd5" = "$md5" ]
   then
      rm -f "$localfile"
      rm -rf "$dir"
      (cd $externalarchives; wget -c $url)
      localmd5=`get_md5 "$localfile"`
      if ! [ "$localmd5" = "$md5" ]
      then
         echo "Failed fetching file with expected md5 sum."
         echo "Expected md5: $md5"
         echo "     Got md5: $localmd5"
         echo "Press Enter to continue or Ctrl+C to abort."
         read
      fi
   fi
   if ! [ "`ls $dir/* 2> /dev/null`" ]
   then
      mkdir -p "$dir"
      case "${url##*.}" in
      gz|tgz) mode=xvzf ;;
      bz2) mode=xvjf ;;
      esac
      sudo tar $mode $localfile -C "$dir"
   fi
}

check_and_dl "$external/Linux-Kernel"  \
    "http://gobo.calica.com/livecd-packages/Linux--2.6.16.2-Gobo--kernel-i686.tar.bz2" \
    "d2538ac43905e1d46971c25e1d60d18a"

check_and_dl "$external/Files-Fonts"  \
    "http://www.calica.com/gobolinux/livecd/Files-Fonts.tar.bz2" \
    "374747070d2585c905e24c0f5d30f029"

check_and_dl "$external/CD-Bootloader"  \
    "http://gobo.calica.com/livecd-packages/CD-Bootloader-i686.tar.bz2" \
    "141c0438c45dcdbee307178d88db93a6"

# Gobo-Files
mkdir -p $external/Gobo-Files
cvs  -q -z3 -d:pserver:anonymous@cvs.sv.gnu.org:/sources/goboscripts co -d $external/Gobo-Files files

rsync --verbose -r gobo.calica.com::gobolinux-packages/013-test/ Archives/Packages/
